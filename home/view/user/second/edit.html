{extend name='user/public/layout' /}
{block name='content'}
<div class="content add_house">
    <form class="layui-form" id="info_form" action="{:url('user.send/saveSecond')}" method="post" enctype="multipart/form-data">
        <div class="layui-tab layui-tab-brief">
            <ul class="layui-tab-title">
                <li class="layui-this">编辑二手房</li>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label"><span class="layui-form-alert">*</span>所属小区 </label>
                            <div class="layui-input-inline">
                                <input type="hidden" name="estate_id" id="estate_id" value="{$info.estate_id}">
                                <input type="text" name="estate_name" value="{$info.estate_name}" lay-verify="estate_id" id="estate_name" class="layui-input" placeholder="锦绣花园">
                            </div>
                            <div class="layui-input-inline" style="width:100px;">
                                <a href="javascript:;" data-uri="{:url('Ajax/ajaxGetEstate')}" id="select_estate" class="layui-btn">选择小区</a>
                            </div>
                        </div>
                        
                        <div class="layui-inline">

                        <label class="layui-form-label"><span class="layui-form-alert">*</span>所属区域</label>

                        <input type="hidden" name="city" id="J_city_id" value="{$info['city']}" />

                        <label class="layui-form-label" style="width:200px;"><span class="layui-form-alert"></span>{:getCityName($info['city'])}</label>

                        </div>

                    </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label"><span class="layui-form-alert">*</span>房源名称</label>
                            <div class="layui-input-inline">
                                <input type="text" name="title" lay-verify="title" placeholder="房源名称" value="{$info.title}" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label"><span class="layui-form-alert">*</span>房型</label>
                            <div class="layui-input-inline" style="width:50px;">
                                <input type="text" name="room"  lay-verify="room" size="10" placeholder="1" value="{$info.room}" autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux layui-fl" style="margin-left:10px;">室</div>
                            <div class="layui-input-inline" style="width:50px;">
                                <input type="text" name="living_room"  lay-verify="living_room" size="10" placeholder="1" value="{$info.living_room}" autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux layui-fl" style="margin-left:10px;">厅</div>
                            <!--div class="layui-input-inline" style="width:50px;">
                                <input type="text" name="kitchen"  lay-verify="kitchen" size="10" placeholder="1" value="" autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux layui-fl" style="margin-left:10px;">厨</div-->
                           <!--  <div class="layui-input-inline" style="width:50px;">
                                <input type="text" name="toilet"  lay-verify="toilet" size="10" placeholder="1" value="{$info.toilet}" autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-form-mid layui-word-aux layui-fl" style="margin-left:10px;">卫</div> -->
                        </div>

                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label"><span class="layui-form-alert">*</span>面积 </label>
                            <div class="layui-input-inline" style="width:95px;">
                                <input type="text" class="layui-input" lay-verify="acreage" id="acreage" name="acreage" placeholder="122"  autocomplete="off" value="{$info.acreage}" >
                            </div>
                            <div class="layui-form-mid layui-word-aux layui-fl" style="margin-left:10px;">㎡ 总价</div>
                            <div class="layui-input-inline" style="width:90px;">
                                <input type="text" class="layui-input" lay-verify="price" id="price" name="price" placeholder="122"  autocomplete="off" value="{$info->getData('price')}" >
                            </div>
                            <div class="layui-form-mid layui-word-aux layui-fl" style="margin-left:10px;">万</div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">朝向 </label>
                            <div class="layui-input-inline">
                                {:getLinkMenu(4,'orientations','select',$info['orientations'])}
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">

                    <div class="layui-inline">

                        <label class="layui-form-label">起拍价 </label>

                        <div class="layui-input-inline">

                            <input type="text" class="layui-input" name="qipai" value="{$info.qipai}" id="qipai" placeholder="100万">

                        </div>

                    </div>

                    <div class="layui-inline">

                        <label class="layui-form-label">保证金 </label>

                        <div class="layui-input-inline">

                            <input type="text" class="layui-input" name="baozheng" value="{$info.baozheng}" id="baozheng" placeholder="100万">

                        </div>

                    </div>

                </div>
                <div class="layui-form-item">

                   <!--  <div class="layui-inline">

                        <label class="layui-form-label">形式 </label>

                        <div class="layui-input-inline">

                            <input type="text" class="layui-input" name="xingshi" value="{$info.xingshi}" id="xingshi" placeholder="">

                        </div>

                    </div> -->
                     <div class="layui-inline">

                        <label class="layui-form-label">成交价格 </label>

                        <div class="layui-input-inline">

                            <input type="text" class="layui-input" name="cjprice" value="{$info.cjprice}" id="cjprice" placeholder="">

                        </div>

                    </div>

                    <div class="layui-inline">

                        <label class="layui-form-label">编号 </label>

                        <div class="layui-input-inline">

                            <input type="text" class="layui-input" name="bianhao" value="{$info.bianhao}" id="bianhao" placeholder="">

                        </div>

                    </div>

                </div>
                
                <div class="layui-form-item">

                    <div class="layui-inline">

                        <label class="layui-form-label">房源瑕疵 </label>

                        <div class="layui-input-inline">

                            <input type="text" class="layui-input" name="xiaci" value="{$info.xiaci}" id="xiaci" placeholder="">

                        </div>

                    </div>

                    <div class="layui-inline">

                        <label class="layui-form-label">欠费情况 </label>

                        <div class="layui-input-inline">

                            <input type="text" class="layui-input" name="qianfei" value="{$info.qianfei}" id="qianfei" placeholder="">

                        </div>

                    </div>

                </div>
                <div class="layui-form-item">


                    <div class="layui-inline">

                        <label class="layui-form-label">房源分类<a href="javascript:;" data-field="jieduan" data-type="select" data-alert="房源分类" data-id="25" data-title="点击我可以管理房源分类" class="layui-icon layui-icon-set attr-manage"></a> </label>

                        <div class="layui-input-inline" style="width:100px;">

                            {:getLinkMenu(25,'jieduan','select',$info['jieduan'])}

                        </div>


                    </div>

                     <link type="text/css" rel="stylesheet" href="__CSS__/calendar.min.css" /> 
                    <div class="layui-inline">

                        <label class="layui-form-label" style="margin-left:200px;">开拍时间 </label>

                        <div class="layui-input-inline">

                            <input type="text" calendar="YYYY-MM-DD hh:mm:ss" class="layui-input" name="kptime" value="{$info.kptime}" id="kptime" placeholder="2019-04-29 16:14:10">
                            

                        </div>

                    </div>
                      <script type="text/javascript" src="__JS__/jquery-1.8.3.min.js"></script>
                      <script type="text/javascript" src="__JS__/calendar.js"></script>

                </div>


                <div class="layui-form-item">

                    <div class="layui-inline">

                        <label class="layui-form-label">一拍开始时间 </label>

                        <div class="layui-input-inline">

                            <!-- <input type="date" class="layui-input" name="onestime" value="{$info.onestime}" id="onestime" placeholder=""> -->
                            <input type="text" calendar="YYYY-MM-DD" class="layui-input" name="onestime" lay-verify="onestime" id="onestime" value="{$info.onestime}" placeholder="">

                        </div>

                    </div>

                    <div class="layui-inline">

                        <label class="layui-form-label">一拍截止时间 </label>

                        <div class="layui-input-inline">

                            <!-- <input type="date" class="layui-input" name="oneetime" value="{$info.oneetime}" id="oneetime" placeholder=""> -->
                            <input type="text" calendar="YYYY-MM-DD" class="layui-input" name="oneetime" lay-verify="oneetime" id="oneetime" value="{$info.oneetime}" placeholder="">

                        </div>

                    </div>
                    <div class="layui-inline">

                        <label class="layui-form-label">一拍价格 </label>

                        <div class="layui-input-inline">

                            <input type="text" class="layui-input" name="oneprice" value="{$info.oneprice}" id="oneprice" placeholder="">

                        </div>

                    </div>

                </div>
                <div class="layui-form-item">

                    <div class="layui-inline">

                        <label class="layui-form-label">二拍开始时间 </label>

                        <div class="layui-input-inline">

                            <!-- <input type="date" class="layui-input" name="twostime" value="{$info.twostime}" id="twostime" placeholder=""> -->
                            <input type="text" calendar="YYYY-MM-DD" class="layui-input" name="twostime" lay-verify="twostime" id="twostime" value="{$info.twostime}" placeholder="">

                        </div>

                    </div>

                    <div class="layui-inline">

                        <label class="layui-form-label">二拍截止时间 </label>

                        <div class="layui-input-inline">

                            <!-- <input type="date" class="layui-input" name="twoetime" value="{$info.twoetime}" id="twoetime" placeholder=""> -->
                            <input type="text" calendar="YYYY-MM-DD" class="layui-input" name="twoetime" lay-verify="twoetime" id="twoetime" value="{$info.twoetime}" placeholder="">

                        </div>

                    </div>
                    <div class="layui-inline">

                        <label class="layui-form-label">二拍价格 </label>

                        <div class="layui-input-inline">

                            <input type="text" class="layui-input" name="twoprice" value="{$info.twoprice}" id="twoprice" placeholder="">

                        </div>

                    </div>

                </div>
                <div class="layui-form-item">

                    <div class="layui-inline">

                        <label class="layui-form-label">变卖开始时间 </label>

                        <div class="layui-input-inline">

                            <!-- <input type="date" class="layui-input" name="bianstime" value="{$info.bianstime}" id="bianstime" placeholder=""> -->
                            <input type="text" calendar="YYYY-MM-DD" class="layui-input" name="bianstime" lay-verify="bianstime" id="bianstime" value="{$info.bianstime}" placeholder="">

                        </div>

                    </div>

                    <div class="layui-inline">

                        <label class="layui-form-label">变卖截止时间 </label>

                        <div class="layui-input-inline">

                            <!-- <input type="date" class="layui-input" name="bianetime" value="{$info.bianetime}" id="bianetime" placeholder=""> -->
                            <input type="text" calendar="YYYY-MM-DD" class="layui-input" name="bianetime" lay-verify="bianetime" id="bianetime" value="{$info.bianetime}" placeholder="">

                        </div>

                    </div>
                    <div class="layui-inline">

                        <label class="layui-form-label">变卖价格 </label>

                        <div class="layui-input-inline">

                            <input type="text" class="layui-input" name="bianprice" value="{$info.bianprice}" id="bianprice" placeholder="">

                        </div>

                    </div>

                </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">房源地址 </label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" name="address" value="{$info.address}" id="address" placeholder="海口市龙华区">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">楼层 </label>
                            <div class="layui-input-inline" style="width:100px;">
                                <!-- {:getLinkMenu(7,'floor','select',$info['floor'])} -->
                                <input type="text" class="layui-input" name="floor" value="{$info.floor}" placeholder="20">
                            </div>
                            <div class="layui-form-mid layui-word-aux layui-fl" style="margin-left:20px;"> 共</div>
                            <div class="layui-input-inline" style="width:100px;">
                                <input type="text" class="layui-input" name="total_floor" value="{$info.total_floor}" placeholder="20">
                            </div>
                            <div class="layui-form-mid layui-word-aux layui-fl" style="margin-left:10px;"> 层</div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">地图坐标 </label>
                            <div class="layui-input-inline" style="width:200px;">
                                <input type="text" class="layui-input" name="map" id="map" placeholder="115.345,22.1349"  autocomplete="off" value="{$info.lng},{$info.lat}" >
                            </div>
                            <div class="layui-input-inline" style="width:95px;">
                                <button type="button" id="mark" data-uri="{:addon_url('map://Map/updateLocation')}" class="layui-btn layui-btn-primary">标注位置</button>
                            </div>
                        </div>
                        <!-- <div class="layui-inline">
                            <label class="layui-form-label">装修情况 </label>
                            <div class="layui-input-block">
                                {:getLinkMenu(8,'renovation','radio',$info['renovation'])}
                            </div>
                        </div> -->
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">联系人 </label>
                            <div class="layui-input-inline">
                                <input type="text" name="contacts[contact_name]" value="{$info.contacts.contact_name}" id="contact_name" placeholder="联系人" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline" style="display:none;">
                            <label class="layui-form-label">联系电话 </label>
                            <div class="layui-input-inline">
                                <input type="text" name="contacts[contact_phone]" id="contact_phone" value="{$info.contacts.contact_phone}" placeholder="联系电话" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <!-- <div class="layui-form-item">
                        <div class="layui-block">
                            <label class="layui-form-label">房间配套 </label>
                            <div class="layui-input-block">
                                {:getLinkMenu(12,'supporting','checkbox',$info['secondHouseData']['supporting'])}
                            </div>
                        </div>
                    </div> -->
                    <div class="layui-form-item">
                        <div class="layui-block">
                            <label class="layui-form-label">房源类型 </label>
                            <div class="layui-input-block">
                                {:getLinkMenu(9,'house_type','radio',$info['house_type'])}
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">

                    <div class="layui-block">

                        <label class="layui-form-label">形式<a href="javascript:;" data-field="types" data-type="radio" data-alert="类型" data-id="26" data-title="点击我可以管理类型" class="layui-icon layui-icon-set attr-manage"></a> </label>

                        <div class="layui-input-block">

                            {:getLinkMenu(26,'types','radio',$info['types'])}

                        </div>

                    </div>

                </div>
                <div class="layui-form-item">

                    <div class="layui-block">

                        <label class="layui-form-label">状态<a href="javascript:;" data-field="fcstatus" data-type="radio" data-alert="状态" data-id="27" data-title="点击我可以管理状态" class="layui-icon layui-icon-set attr-manage"></a> </label>

                        <div class="layui-input-block">

                            {:getLinkMenu(27,'fcstatus','radio',$info['fcstatus'])}

                        </div>

                    </div>

                </div>

                    <div class="layui-form-item">
                        <div class="layui-block">
                            <label class="layui-form-label">特色标签 </label>
                            <div class="layui-input-block">
                                {:getLinkMenu(14,'tags','checkbox',$info['tags'])}
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-block">
                            <label class="layui-form-label">有效期 </label>
                            <div class="layui-input-block" style="line-height: 40px;">
                                {if condition="$info.timeout lt time()"}
                                <span style="color:#ff0000;">{$info.timeout|date='Y-m-d H:i:s'}过期，重新上架</span>
                                <select name="timeout" id="timeout">
                                    {volist name=':getHouseTimeOut()' id='vo'}
                                    <option value="{$key}" {if condition="$key eq 7"}selected="selected"{/if}>{$vo}</option>
                                    {/volist}
                                </select>
                                {else /}
                                {$info.timeout|date='Y-m-d H:i:s'}到期
                                {/if}
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">缩略图</label>
                        <div class="layui-input-block">
                            <div class="layui-upload">
                                <input type="hidden" name="img" value="{$info.img}" id="img_txt">
                                <button type="button" class="layui-btn layui-btn-primary" id="img">上传图片</button>
                                <div id="img_preview">
                                    {notempty name='info.img'}
                                    <img class='layui-upload-img' src="{$info.img}" alt="" width="100" />
                                    <a href='javascript:;' data-text='img_txt' data-src='{$info.img}' class='deleteImg layui-btn layui-btn-xs layui-btn-danger'>删除</a>
                                    {/notempty}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">房源图片</label>
                        <div class="layui-input-block">
                            <div class="layui-upload">
                                <script id="uploadpic" name="uploadpic" type="text/plain"></script>
                                <button type="button" class="layui-btn layui-btn-primary" onclick="upImage();">选择图片</button>
                                <div id="imageList">
                                    <ul class="list clearfix">
                                        {volist name="info.secondHouseData.file" id="vo"}
                                        <li>
                                            <img width="113" height="113" alt="{$vo.title}" src="{$vo.url}">
                                            <input type="hidden" value="{$vo.url}" name="pic[{$i+100}][pic]">
                                            <input type="text" class="imgtitletxt" value="{$vo.title}" name="pic[{$i+100}][alt]">
                                            <div class="delbox"><span class="del">删除</span></div>
                                        </li>
                                        {/volist}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                  
                     <div class="layui-form-item">

                    <label class="layui-form-label">尽调报告</label>

                    <div class="layui-input-block">

                        <div class="layui-upload">


                        <input type="file" name="hxsimg" value="{$info.hxsimg}" >
{if condition='$info.hxsimg neq ""'  }

                             <div id="img_preview">
                             <a href="{$info.hxsimg}" download="{$info.hxsimg}">已上传，点击下载</a>
                             
                             </div>
                          {/if}  

                        </div>

                    </div>

                </div>


                 <div class="layui-form-item">

                        <label class="layui-form-label">发布时间 </label>

                        <div class="layui-input-inline">

                            <input type="text" calendar="YYYY-MM-DD hh:mm:ss" class="layui-input" name="fabutime" value="{$info.fabutime}" id="fabutime" placeholder="">
                            

                        </div>

                    </div>
                     <div class="layui-form-item">

                        <label class="layui-form-label">成交时间 </label>

                        <div class="layui-input-inline">

                            <input type="text" calendar="YYYY-MM-DD hh:mm:ss" class="layui-input" name="endtime" value="{$info.endtime}" id="endtime" placeholder="">
                            

                        </div>

                    </div>
                

                <div class="layui-form-item">

                    <label class="layui-form-label">全景看房</label>

                    <div class="layui-input-inline" style="width:600px;">

                        <input name="pano_url" id="pano_url" placeholder="复制全景链接地址到输入框" value="{$info.pano_url}" class="layui-input" />

                    </div>

                </div>

                <div class="layui-form-item">

                    <label class="layui-form-label">拍卖公告</label>

                    <div class="layui-input-block">

                        <script id="info" name="info" type="text/plain">{$data.info|raw}</script>

                    </div>

                </div>
             
            





                    <!--< div class="layui-form-item">
                        <label class="layui-form-label">房源介绍</label>
                        <div class="layui-input-block">
                            <script id="info" name="info" type="text/plain">{$info.secondHouseData.info|raw}</script>
                        </div>
                    </div> -->
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">&nbsp;</label>
            <input type="hidden" name="back_url" id="back_url" value="{$back_url}" />
            <input type="hidden" name="id" id="id" value="{$info.id}">
            <button type="button" lay-submit="" class="layui-btn btn-submit layui-btn-danger w240">提交</button>
        </div>
    </form>

</div>
{:hook('ueditor',['id'=>'info','width'=>'100%','height'=>220,'mini'=>true,'upload'=>true])}
<script>
    var deleteImgUrl = "{:url('user.send/deleteImg')}";
    //注意：选项卡 依赖 element 模块，否则无法进行功能性操作
    layui.use(['form','element','upload','linkmenu'], function(){
        var $ = layui.jquery,element = layui.element,layer = layui.layer,form = layui.form,upload = layui.upload,menu = layui.linkmenu;
        $(".J_city_select").select({field : 'J_city_id',id : 'J_city_select'});

//普通图片上传
        upload.render({
            elem: '#img'
            ,auto:false
            ,choose: function(obj){
                if(!IEVersion())
                {
                    $('#img_preview').html($('.layui-upload-file').val());
                }else {
                    //预读本地文件示例，不支持ie8
                    obj.preview(function (index, file, result) {
                        var img = "<img class='layui-upload-img' src='" + result + "' width='100'/>";
                        $('#img_preview').html(img); //图片链接（base64）
                    });
                }
            }
            ,done: function(res){console.log(res);
                //如果上传失败
                if(res.code == 0){
                    return layer.msg('上传失败');
                }else{
                    var img = "<img class='layui-upload-img' src='"+res.data+"' width='100'/><a href='javascript:;' data-text='img_txt' data-src='"+res.data+"' class='deleteImg layui-btn layui-btn-xs layui-btn-danger'>删除</a>";
                    $("#img_txt").val(res.data);
                    $("#img_preview").html(img);
                }
                //上传成功
            }

        });
        $('.btn-submit').on('click',function(){
            var title = $("input[lay-verify='title']"),
                    estate_name = $("input[lay-verify='estate_id']"),
                    acreage     = $("input[lay-verify='acreage']"),
                    price       = $("input[lay-verify='price']");
            if(title.val().length == 0)
            {
                layer.msg('请填写房源标题',{icon:5});
                title.focus();
                return false;
            }else if(estate_name.val().length == 0){
                layer.msg('请填写小区名称',{icon:5});

                return false;
            }else if(!/^\d+\.?\d{0,2}$/.test(acreage.val())){
                layer.msg('面积只能为数字,最多保留两位小数',{icon:5});
                acreage.focus();
                return false;
            }else if(price.val().length > 0 && !/^\d+\.?\d{0,2}$/.test(price.val())){
                layer.msg('价格只能为数字,最多保留两位小数',{icon:5});
                price.focus();
                return false;
            }else{
                layer.load(1);
                $("#info_form").submit();
            }
        });
        $("#address").on('blur',function(){
            var city = $("#J_city_id").val();
            var address = $(this).val(),url = "{:addon_url('map://Map/getLocationByAddress')}";
            var param = {
                city : city,
                address : address
            };
            $.get(url,param,function(res){
                if(res.code == 1)
                {
                    $("#map").val(res.data.map);
                }
            });
        });
        $("#mark").on('click',function(){
            var url = $(this).data('uri');
            var map = $('#map').val();
            var city = $("#J_city_id").val();console.log(city);
            if(!map)
            {
                if(!city)
                {
                    layer.msg('请选择城市',{icon:2});
                    return false;
                }
            }
            url += '?map='+map+'&city='+city;
            layer.open(
                    {
                        type : 2,
                        title : '地图标注',
                        area : ['100%','100%'],
                        shade : 0.2,
                        content : url,
                        iframeAuto:true
                    }
            );
        });
        $("#select_estate").on('focus',function(){
            layer.open({
                type : 2,
                title : '选择小区',
                area : ['600px','600px'],
                shade : 0.2,
                content : $(this).data('uri'),
                iframeAuto:true,
                end : function(){
                    var select = $("#J_city_select");
                    select.html('');
                    select.nextAll().remove();
                    select.select({field : 'J_city_id',id : 'J_city_select'});
                }
            });
        });
        $(document).on('click','.deleteImg',function(){
            var that = $(this),img = $(this).data('src'),textId = $(this).data('text'),id = $("#id").val();
            layer.confirm('确定要删除图片么?', {icon: 3, title:'提示'}, function(index){
                var param = {
                    'path' : img,
                    'id'   : id,
                    'field': 'img'
                };
                $.post(deleteImgUrl,param,function(res){
                    layer.close(index);
                    if(res.code == 1){
                        $("#"+textId).val('');
                        that.parent().html('');
                    }else{
                        layer.msg(res.msg,{icon:2});
                    }
                });
            });

        });
    });
</script>

{/block}